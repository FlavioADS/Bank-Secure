<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApoliceDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">banksecure</a> &gt; <a href="index.source.html" class="el_package">com.banksecure.infra.DAO</a> &gt; <span class="el_source">ApoliceDAO.java</span></div><h1>ApoliceDAO.java</h1><pre class="source lang-java linenums">package com.banksecure.infra.DAO;

import com.banksecure.domain.Apolice;
import com.banksecure.enums.TipoDeSeguroEnum;
import com.banksecure.exception.DadosInvalidosException;
import com.banksecure.exception.EstruturaBancoException;
import com.banksecure.infra.db.ConnectionFactory;
import com.banksecure.service.ApoliceService;

import java.math.BigDecimal;
import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L16">public class ApoliceDAO {</span>

<span class="fc" id="L18">    private ApoliceService apoliceService = new ApoliceService();</span>

    public void iniciaTabela() {
<span class="fc" id="L21">        this.createTable();</span>
<span class="pc bpc" id="L22" title="1 of 2 branches missed.">        if (tabelaVazia()) {</span>
<span class="fc" id="L23">            popularRegistro();</span>
        }
<span class="fc" id="L25">    }</span>

    public void popularRegistro() {
        try {
<span class="fc" id="L29">            Apolice apolice = new Apolice(1L,1L,1L,new BigDecimal(&quot;17000&quot;), LocalDate.now(), LocalDate.now().plusDays(30),false);</span>
<span class="fc" id="L30">            this.save(apolice);</span>

<span class="nc" id="L32">        } catch (Exception e) {</span>
<span class="nc" id="L33">            e.printStackTrace();</span>
<span class="nc" id="L34">            throw new EstruturaBancoException(&quot;Erro ao popular tabela apolice&quot;);</span>
<span class="fc" id="L35">        }</span>
<span class="fc" id="L36">    }</span>

    private boolean tabelaVazia() {
<span class="fc" id="L39">        String sql = &quot;SELECT COUNT(*) FROM apolice&quot;;</span>
<span class="fc" id="L40">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L41">             Statement stmt = con.createStatement();</span>
<span class="fc" id="L42">             ResultSet rs = stmt.executeQuery(sql)) {</span>

<span class="fc" id="L44">            rs.next();</span>
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">            return rs.getInt(1) == 0;</span>

<span class="nc" id="L47">        } catch (Exception e) {</span>
<span class="nc" id="L48">            throw new EstruturaBancoException(&quot;Erro ao verificar tabela de apolices&quot;);</span>
        }
    }

    public void createTable() {
<span class="fc" id="L53">            String sqlTabela = &quot;&quot;&quot;</span>
                    CREATE TABLE IF NOT EXISTS apolice(
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    cliente_id INT NOT NULL,
                    seguro_id INT NOT NULL,
                    funcionario_id INT NOT NULL,
                    valorFinal DECIMAL(10,2) NOT NULL,
                    dataInicio DATE NOT NULL,
                    dataFim DATE NOT NULL,
                    renovada BOOLEAN NOT NULL,
                    CONSTRAINT fk_idCliente FOREIGN KEY (cliente_id) REFERENCES clientes(id),
                    CONSTRAINT fk_idSeguro FOREIGN KEY (seguro_id)  REFERENCES seguro(id),
                    CONSTRAINT fk_idFuncionario FOREIGN KEY (funcionario_id)  REFERENCES funcionarios(id)
                    );
                    &quot;&quot;&quot;;

<span class="fc" id="L69">        try(Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L70">            Statement smtm = con.createStatement()){</span>
<span class="fc" id="L71">            smtm.execute(sqlTabela);</span>
<span class="nc" id="L72">        }catch (Exception e){</span>
<span class="nc" id="L73">            e.printStackTrace();</span>
<span class="nc" id="L74">            throw new RuntimeException(&quot;Erro ao criar tabela apolice&quot;, e);</span>
<span class="fc" id="L75">        }</span>
<span class="fc" id="L76">    }</span>

    public void save(Apolice apolice) {

<span class="fc" id="L80">        apoliceService.validarApoliceDAO(apolice);</span>

<span class="fc" id="L82">        String sqlInsert = &quot;INSERT INTO apolice (cliente_id, seguro_id, funcionario_id, valorFinal, dataInicio, dataFim, renovada) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;;</span>

<span class="fc" id="L84">        try(Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L85">            PreparedStatement prepared = con.prepareStatement(sqlInsert, Statement.RETURN_GENERATED_KEYS)){</span>

<span class="fc" id="L87">            prepared.setLong(1, apolice.getCliente_id());</span>
<span class="fc" id="L88">            prepared.setLong(2, apolice.getSeguro_id());</span>
<span class="fc" id="L89">            prepared.setLong(3, apolice.getFuncionario_id());</span>
<span class="fc" id="L90">            prepared.setBigDecimal(4, apolice.getValorFinal());</span>
<span class="fc" id="L91">            prepared.setDate(5, Date.valueOf(apolice.getDataInicio()));</span>
<span class="fc" id="L92">            prepared.setDate(6, Date.valueOf(apolice.getDataFim()));</span>
<span class="fc" id="L93">            prepared.setBoolean(7,apolice.isRenovada());</span>
<span class="fc" id="L94">            prepared.execute();</span>
<span class="fc" id="L95">            try (ResultSet rs = prepared.getGeneratedKeys()) {</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">                if (rs.next()) {</span>
<span class="fc" id="L97">                    apolice.setId(rs.getLong(1));</span>
                }
            }

<span class="nc" id="L101">        }catch (SQLException e){</span>
<span class="nc" id="L102">            throw new DadosInvalidosException(&quot;Erro ao salvar apolice no banco de dados&quot;);</span>
<span class="fc" id="L103">        }</span>
<span class="fc" id="L104">    }</span>

    public List&lt;Apolice&gt; getAll(){

<span class="fc" id="L108">        String sqlSelect = &quot;SELECT * FROM apolice INNER JOIN clientes ON apolice.cliente_id = clientes.id INNER JOIN seguro ON apolice.seguro_id=seguro.id INNER JOIN funcionarios ON apolice.funcionario_id = funcionarios.id&quot;;</span>

<span class="fc" id="L110">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L111">             Statement stmt = con.createStatement();</span>
<span class="fc" id="L112">             ResultSet rs = stmt.executeQuery(sqlSelect)){</span>
<span class="fc" id="L113">            List&lt;Apolice&gt; apolices = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L115" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L116">                apolices.add(</span>
                        new Apolice(
<span class="fc" id="L118">                                rs.getLong(&quot;id&quot;),</span>
<span class="fc" id="L119">                                rs.getLong(&quot;cliente_id&quot;),</span>
<span class="fc" id="L120">                                rs.getLong(&quot;seguro_id&quot;),</span>
<span class="fc" id="L121">                                rs.getLong(&quot;funcionario_id&quot;),</span>
<span class="fc" id="L122">                                rs.getBigDecimal(&quot;valorFinal&quot;),</span>
<span class="fc" id="L123">                                rs.getDate(&quot;dataInicio&quot;).toLocalDate(),</span>
<span class="fc" id="L124">                                rs.getDate(&quot;dataFim&quot;).toLocalDate(),</span>
<span class="fc" id="L125">                                rs.getBoolean(&quot;renovada&quot;)));</span>

<span class="fc" id="L127">                        apolices.get(apolices.size() -1).setNomeCliente(rs.getString(&quot;clientes.nome&quot;));</span>
<span class="fc" id="L128">                        apolices.get(apolices.size() -1).setNomeSeguro(TipoDeSeguroEnum.valueOf(rs.getString(&quot;seguro.tipo&quot;)));</span>
<span class="fc" id="L129">                        apolices.get(apolices.size() -1).setNomeFuncionario(rs.getString(&quot;funcionarios.usuario&quot;));</span>
            }

<span class="fc" id="L132">            return apolices;</span>

<span class="nc" id="L134">        }catch (SQLException e){</span>
<span class="nc" id="L135">            throw new EstruturaBancoException(&quot;Erro ao buscar apólices no banco de dados&quot;);</span>
        }
    }

    public void renovarApolice(Apolice apoliceExistente, BigDecimal novoValorFinal, LocalDate novaDataFim){
<span class="fc" id="L140">        Apolice novaApolice = new Apolice(</span>
<span class="fc" id="L141">                apoliceExistente.getCliente_id(),</span>
<span class="fc" id="L142">                apoliceExistente.getSeguro_id(),</span>
<span class="fc" id="L143">                apoliceExistente.getFuncionario_id(),</span>
                novoValorFinal,
<span class="fc" id="L145">                LocalDate.now(),</span>
                novaDataFim,
                false
        );

<span class="fc" id="L150">        this.save(novaApolice);</span>
<span class="fc" id="L151">        update(apoliceExistente.getId());</span>
<span class="fc" id="L152">    }</span>

    public List&lt;Apolice&gt; getByDueDate(){

<span class="fc" id="L156">        String sql =</span>
                &quot;SELECT * FROM apolice &quot; +
                        &quot;INNER JOIN clientes ON apolice.cliente_id = clientes.id &quot; +
                        &quot;INNER JOIN seguro ON apolice.seguro_id = seguro.id &quot; +
                        &quot;INNER JOIN funcionarios ON apolice.funcionario_id = funcionarios.id &quot; +
                        &quot;WHERE dataFim BETWEEN ? AND ? AND renovada = FALSE&quot;;

<span class="fc" id="L163">        LocalDate hoje = LocalDate.now();</span>
<span class="fc" id="L164">        LocalDate dataVencimento = hoje.plusDays(30);</span>

        try (
<span class="fc" id="L167">                Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L168">                PreparedStatement stmt = con.prepareStatement(sql)</span>
        ) {

<span class="fc" id="L171">            stmt.setDate(1, Date.valueOf(hoje));</span>
<span class="fc" id="L172">            stmt.setDate(2, Date.valueOf(dataVencimento));</span>

<span class="fc" id="L174">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="fc" id="L175">                List&lt;Apolice&gt; apolices = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L177" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L178">                    apolices.add(new Apolice(</span>
<span class="fc" id="L179">                            rs.getLong(&quot;id&quot;),</span>
<span class="fc" id="L180">                            rs.getLong(&quot;cliente_id&quot;),</span>
<span class="fc" id="L181">                            rs.getLong(&quot;seguro_id&quot;),</span>
<span class="fc" id="L182">                            rs.getLong(&quot;funcionario_id&quot;),</span>
<span class="fc" id="L183">                            rs.getBigDecimal(&quot;valorFinal&quot;),</span>
<span class="fc" id="L184">                            rs.getDate(&quot;dataInicio&quot;).toLocalDate(),</span>
<span class="fc" id="L185">                            rs.getDate(&quot;dataFim&quot;).toLocalDate(),</span>
<span class="fc" id="L186">                            rs.getBoolean(&quot;renovada&quot;)</span>
                    ));

<span class="fc" id="L189">                    apolices.get(apolices.size() - 1)</span>
<span class="fc" id="L190">                            .setNomeCliente(rs.getString(&quot;clientes.nome&quot;));</span>
<span class="fc" id="L191">                    apolices.get(apolices.size() - 1)</span>
<span class="fc" id="L192">                            .setNomeSeguro(</span>
<span class="fc" id="L193">                                    TipoDeSeguroEnum.valueOf(rs.getString(&quot;seguro.tipo&quot;))</span>
                            );
<span class="fc" id="L195">                    apolices.get(apolices.size() - 1)</span>
<span class="fc" id="L196">                            .setNomeFuncionario(</span>
<span class="fc" id="L197">                                    rs.getString(&quot;funcionarios.usuario&quot;)</span>
                            );
                }
<span class="fc" id="L200">                return apolices;</span>
            }

<span class="nc" id="L203">        } catch (SQLException e) {</span>
<span class="nc" id="L204">            throw new EstruturaBancoException(</span>
                    &quot;Erro ao buscar apolices com vencimento em 30 dias no banco de dados&quot;
            );
        }
    }

    public Apolice getById(Long id){
<span class="nc" id="L211">        String sqlSelect = &quot;SELECT * FROM apolice WHERE id = ?&quot;;</span>

<span class="nc" id="L213">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="nc" id="L214">        PreparedStatement stmt = con.prepareStatement(sqlSelect)) {</span>

<span class="nc" id="L216">            stmt.setLong(1, id);</span>
<span class="nc" id="L217">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L219">                    return new Apolice(</span>
<span class="nc" id="L220">                            rs.getLong(&quot;id&quot;),</span>
<span class="nc" id="L221">                            rs.getLong(&quot;cliente_id&quot;),</span>
<span class="nc" id="L222">                            rs.getLong(&quot;seguro_id&quot;),</span>
<span class="nc" id="L223">                            rs.getLong(&quot;funcionario_id&quot;),</span>
<span class="nc" id="L224">                            rs.getBigDecimal(&quot;valorFinal&quot;),</span>
<span class="nc" id="L225">                            rs.getDate(&quot;dataInicio&quot;).toLocalDate(),</span>
<span class="nc" id="L226">                            rs.getDate(&quot;dataFim&quot;).toLocalDate(),</span>
<span class="nc" id="L227">                            rs.getBoolean(&quot;renovada&quot;)</span>
                    );
                }else {
<span class="nc" id="L230">                    throw new EstruturaBancoException(&quot;Apolice não encontrada: id=&quot; + id);</span>
                }
            }

<span class="nc" id="L234">        }catch (SQLException e){</span>
<span class="nc" id="L235">            throw new EstruturaBancoException(&quot;Erro ao buscar apolices no banco de dados&quot;);</span>
        }
    }

    private void update(Long id){
<span class="fc" id="L240">        String sqlUpdate = &quot;UPDATE apolice SET renovada = TRUE WHERE id = ?&quot;;</span>
<span class="fc" id="L241">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L242">        PreparedStatement stmt = con.prepareStatement(sqlUpdate)){</span>

<span class="fc" id="L244">            stmt.setLong(1, id);</span>
<span class="fc" id="L245">            stmt.executeUpdate();</span>
<span class="nc" id="L246">        }catch (SQLException e){</span>
<span class="nc" id="L247">            throw new DadosInvalidosException(&quot;Erro ao atualizar apolices no banco de dados&quot;);</span>
<span class="fc" id="L248">        }</span>
<span class="fc" id="L249">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>