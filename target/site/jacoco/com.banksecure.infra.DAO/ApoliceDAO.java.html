<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApoliceDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">banksecure</a> &gt; <a href="index.source.html" class="el_package">com.banksecure.infra.DAO</a> &gt; <span class="el_source">ApoliceDAO.java</span></div><h1>ApoliceDAO.java</h1><pre class="source lang-java linenums">package com.banksecure.infra.DAO;

import com.banksecure.domain.Apolice;
import com.banksecure.enums.TipoDeSeguroEnum;
import com.banksecure.exception.DadosInvalidosException;
import com.banksecure.exception.EstruturaBancoException;
import com.banksecure.infra.db.ConnectionFactory;
import com.banksecure.service.ApoliceService;

import java.math.BigDecimal;
import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L16">public class ApoliceDAO {</span>

<span class="fc" id="L18">    private ApoliceService apoliceService = new ApoliceService();</span>

    public void iniciaTabela() {
<span class="fc" id="L21">        this.createTable();</span>
<span class="pc bpc" id="L22" title="1 of 2 branches missed.">        if (tabelaVazia()) {</span>
<span class="fc" id="L23">            popularRegistro();</span>
        }
<span class="fc" id="L25">    }</span>

    public void popularRegistro() {
        try {
<span class="fc" id="L29">            Apolice apolice1 = new Apolice(1L,1L,1L,new BigDecimal(&quot;17000&quot;), LocalDate.now(), LocalDate.now().plusDays(30),false);</span>
<span class="fc" id="L30">            this.save(apolice1);</span>

<span class="fc" id="L32">            Apolice apolice2 = new Apolice(2L,2L,2L,new BigDecimal(&quot;18000&quot;), LocalDate.now(), LocalDate.now().plusYears(1),false);</span>
<span class="fc" id="L33">            this.save(apolice2);</span>

<span class="fc" id="L35">            Apolice apolice3 = new Apolice(3L,3L,1L,new BigDecimal(&quot;16500&quot;), LocalDate.now(), LocalDate.now().plusDays(30),false);</span>
<span class="fc" id="L36">            this.save(apolice3);</span>

<span class="fc" id="L38">            Apolice apolice4 = new Apolice(4L,1L,2L,new BigDecimal(&quot;17250&quot;), LocalDate.now(), LocalDate.now().plusYears(1),false);</span>
<span class="fc" id="L39">            this.save(apolice4);</span>

<span class="fc" id="L41">            Apolice apolice5 = new Apolice(5L,2L,1L,new BigDecimal(&quot;16000&quot;), LocalDate.now(), LocalDate.now().plusYears(1),false);</span>
<span class="fc" id="L42">            this.save(apolice5);</span>

<span class="fc" id="L44">            Apolice apolice6 = new Apolice(6L,3L,2L,new BigDecimal(&quot;17500&quot;), LocalDate.now(), LocalDate.now().plusYears(1),false);</span>
<span class="fc" id="L45">            this.save(apolice6);</span>

<span class="nc" id="L47">        } catch (Exception e) {</span>
<span class="nc" id="L48">            e.printStackTrace();</span>
<span class="nc" id="L49">            throw new EstruturaBancoException(&quot;Erro ao popular tabela apolice&quot;);</span>
<span class="fc" id="L50">        }</span>
<span class="fc" id="L51">    }</span>

    private boolean tabelaVazia() {
<span class="fc" id="L54">        String sql = &quot;SELECT COUNT(*) FROM apolice&quot;;</span>
<span class="fc" id="L55">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L56">             Statement stmt = con.createStatement();</span>
<span class="fc" id="L57">             ResultSet rs = stmt.executeQuery(sql)) {</span>

<span class="fc" id="L59">            rs.next();</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">            return rs.getInt(1) == 0;</span>

<span class="nc" id="L62">        } catch (Exception e) {</span>
<span class="nc" id="L63">            throw new EstruturaBancoException(&quot;Erro ao verificar tabela de apolices&quot;);</span>
        }
    }

    public void createTable() {
<span class="fc" id="L68">            String sqlTabela = &quot;&quot;&quot;</span>
                    CREATE TABLE IF NOT EXISTS apolice(
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    cliente_id INT NOT NULL,
                    seguro_id INT NOT NULL,
                    funcionario_id INT NOT NULL,
                    valorFinal DECIMAL(10,2) NOT NULL,
                    dataInicio DATE NOT NULL,
                    dataFim DATE NOT NULL,
                    renovada BOOLEAN NOT NULL,
                    CONSTRAINT fk_idCliente FOREIGN KEY (cliente_id) REFERENCES clientes(id),
                    CONSTRAINT fk_idSeguro FOREIGN KEY (seguro_id)  REFERENCES seguro(id),
                    CONSTRAINT fk_idFuncionario FOREIGN KEY (funcionario_id)  REFERENCES funcionarios(id)
                    );
                    &quot;&quot;&quot;;

<span class="fc" id="L84">        try(Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L85">            Statement smtm = con.createStatement()){</span>
<span class="fc" id="L86">            smtm.execute(sqlTabela);</span>
<span class="nc" id="L87">        }catch (Exception e){</span>
<span class="nc" id="L88">            e.printStackTrace();</span>
<span class="nc" id="L89">            throw new RuntimeException(&quot;Erro ao criar tabela apolice&quot;, e);</span>
<span class="fc" id="L90">        }</span>
<span class="fc" id="L91">    }</span>

    public void save(Apolice apolice) {

<span class="fc" id="L95">        apoliceService.validarApoliceDAO(apolice);</span>

<span class="fc" id="L97">        String sqlInsert = &quot;INSERT INTO apolice (cliente_id, seguro_id, funcionario_id, valorFinal, dataInicio, dataFim, renovada) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;;</span>

<span class="fc" id="L99">        try(Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L100">            PreparedStatement prepared = con.prepareStatement(sqlInsert, Statement.RETURN_GENERATED_KEYS)){</span>

<span class="fc" id="L102">            prepared.setLong(1, apolice.getCliente_id());</span>
<span class="fc" id="L103">            prepared.setLong(2, apolice.getSeguro_id());</span>
<span class="fc" id="L104">            prepared.setLong(3, apolice.getFuncionario_id());</span>
<span class="fc" id="L105">            prepared.setBigDecimal(4, apolice.getValorFinal());</span>
<span class="fc" id="L106">            prepared.setDate(5, Date.valueOf(apolice.getDataInicio()));</span>
<span class="fc" id="L107">            prepared.setDate(6, Date.valueOf(apolice.getDataFim()));</span>
<span class="fc" id="L108">            prepared.setBoolean(7,apolice.isRenovada());</span>
<span class="fc" id="L109">            prepared.execute();</span>
<span class="fc" id="L110">            try (ResultSet rs = prepared.getGeneratedKeys()) {</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">                if (rs.next()) {</span>
<span class="fc" id="L112">                    apolice.setId(rs.getLong(1));</span>
                }
            }

<span class="nc" id="L116">        }catch (SQLException e){</span>
<span class="nc" id="L117">            throw new DadosInvalidosException(&quot;Erro ao salvar apolice no banco de dados&quot;);</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">    }</span>

    public List&lt;Apolice&gt; getAll(){

<span class="fc" id="L123">        String sqlSelect = &quot;SELECT * FROM apolice INNER JOIN clientes ON apolice.cliente_id = clientes.id INNER JOIN seguro ON apolice.seguro_id=seguro.id INNER JOIN funcionarios ON apolice.funcionario_id = funcionarios.id&quot;;</span>

<span class="fc" id="L125">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L126">             Statement stmt = con.createStatement();</span>
<span class="fc" id="L127">             ResultSet rs = stmt.executeQuery(sqlSelect)){</span>
<span class="fc" id="L128">            List&lt;Apolice&gt; apolices = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L131">                apolices.add(</span>
                        new Apolice(
<span class="fc" id="L133">                                rs.getLong(&quot;id&quot;),</span>
<span class="fc" id="L134">                                rs.getLong(&quot;cliente_id&quot;),</span>
<span class="fc" id="L135">                                rs.getLong(&quot;seguro_id&quot;),</span>
<span class="fc" id="L136">                                rs.getLong(&quot;funcionario_id&quot;),</span>
<span class="fc" id="L137">                                rs.getBigDecimal(&quot;valorFinal&quot;),</span>
<span class="fc" id="L138">                                rs.getDate(&quot;dataInicio&quot;).toLocalDate(),</span>
<span class="fc" id="L139">                                rs.getDate(&quot;dataFim&quot;).toLocalDate(),</span>
<span class="fc" id="L140">                                rs.getBoolean(&quot;renovada&quot;)));</span>

<span class="fc" id="L142">                        apolices.get(apolices.size() -1).setNomeCliente(rs.getString(&quot;clientes.nome&quot;));</span>
<span class="fc" id="L143">                        apolices.get(apolices.size() -1).setNomeSeguro(TipoDeSeguroEnum.valueOf(rs.getString(&quot;seguro.tipo&quot;)));</span>
<span class="fc" id="L144">                        apolices.get(apolices.size() -1).setNomeFuncionario(rs.getString(&quot;funcionarios.usuario&quot;));</span>
            }

<span class="fc" id="L147">            return apolices;</span>

<span class="nc" id="L149">        }catch (SQLException e){</span>
<span class="nc" id="L150">            throw new EstruturaBancoException(&quot;Erro ao buscar apólices no banco de dados&quot;);</span>
        }
    }

    public void renovarApolice(Apolice apoliceExistente, BigDecimal novoValorFinal, LocalDate novaDataFim){
<span class="fc" id="L155">        Apolice novaApolice = new Apolice(</span>
<span class="fc" id="L156">                apoliceExistente.getCliente_id(),</span>
<span class="fc" id="L157">                apoliceExistente.getSeguro_id(),</span>
<span class="fc" id="L158">                apoliceExistente.getFuncionario_id(),</span>
                novoValorFinal,
<span class="fc" id="L160">                LocalDate.now(),</span>
                novaDataFim,
                false
        );

<span class="fc" id="L165">        this.save(novaApolice);</span>
<span class="fc" id="L166">        update(apoliceExistente.getId());</span>
<span class="fc" id="L167">    }</span>

    public List&lt;Apolice&gt; getByDueDate(){

<span class="fc" id="L171">        String sql =</span>
                &quot;SELECT * FROM apolice &quot; +
                        &quot;INNER JOIN clientes ON apolice.cliente_id = clientes.id &quot; +
                        &quot;INNER JOIN seguro ON apolice.seguro_id = seguro.id &quot; +
                        &quot;INNER JOIN funcionarios ON apolice.funcionario_id = funcionarios.id &quot; +
                        &quot;WHERE dataFim BETWEEN ? AND ? AND renovada = FALSE&quot;;

<span class="fc" id="L178">        LocalDate hoje = LocalDate.now();</span>
<span class="fc" id="L179">        LocalDate dataVencimento = hoje.plusDays(30);</span>

        try (
<span class="fc" id="L182">                Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L183">                PreparedStatement stmt = con.prepareStatement(sql)</span>
        ) {

<span class="fc" id="L186">            stmt.setDate(1, Date.valueOf(hoje));</span>
<span class="fc" id="L187">            stmt.setDate(2, Date.valueOf(dataVencimento));</span>

<span class="fc" id="L189">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="fc" id="L190">                List&lt;Apolice&gt; apolices = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L192" title="All 2 branches covered.">                while (rs.next()) {</span>
<span class="fc" id="L193">                    apolices.add(new Apolice(</span>
<span class="fc" id="L194">                            rs.getLong(&quot;id&quot;),</span>
<span class="fc" id="L195">                            rs.getLong(&quot;cliente_id&quot;),</span>
<span class="fc" id="L196">                            rs.getLong(&quot;seguro_id&quot;),</span>
<span class="fc" id="L197">                            rs.getLong(&quot;funcionario_id&quot;),</span>
<span class="fc" id="L198">                            rs.getBigDecimal(&quot;valorFinal&quot;),</span>
<span class="fc" id="L199">                            rs.getDate(&quot;dataInicio&quot;).toLocalDate(),</span>
<span class="fc" id="L200">                            rs.getDate(&quot;dataFim&quot;).toLocalDate(),</span>
<span class="fc" id="L201">                            rs.getBoolean(&quot;renovada&quot;)</span>
                    ));

<span class="fc" id="L204">                    apolices.get(apolices.size() - 1)</span>
<span class="fc" id="L205">                            .setNomeCliente(rs.getString(&quot;clientes.nome&quot;));</span>
<span class="fc" id="L206">                    apolices.get(apolices.size() - 1)</span>
<span class="fc" id="L207">                            .setNomeSeguro(</span>
<span class="fc" id="L208">                                    TipoDeSeguroEnum.valueOf(rs.getString(&quot;seguro.tipo&quot;))</span>
                            );
<span class="fc" id="L210">                    apolices.get(apolices.size() - 1)</span>
<span class="fc" id="L211">                            .setNomeFuncionario(</span>
<span class="fc" id="L212">                                    rs.getString(&quot;funcionarios.usuario&quot;)</span>
                            );
                }
<span class="fc" id="L215">                return apolices;</span>
            }

<span class="nc" id="L218">        } catch (SQLException e) {</span>
<span class="nc" id="L219">            throw new EstruturaBancoException(</span>
                    &quot;Erro ao buscar apolices com vencimento em 30 dias no banco de dados&quot;
            );
        }
    }

    public Apolice getById(Long id){
<span class="fc" id="L226">        String sqlSelect = &quot;SELECT * FROM apolice WHERE id = ?&quot;;</span>

<span class="fc" id="L228">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L229">        PreparedStatement stmt = con.prepareStatement(sqlSelect)) {</span>

<span class="fc" id="L231">            stmt.setLong(1, id);</span>
<span class="fc" id="L232">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">                if (rs.next()) {</span>
<span class="fc" id="L234">                    return new Apolice(</span>
<span class="fc" id="L235">                            rs.getLong(&quot;id&quot;),</span>
<span class="fc" id="L236">                            rs.getLong(&quot;cliente_id&quot;),</span>
<span class="fc" id="L237">                            rs.getLong(&quot;seguro_id&quot;),</span>
<span class="fc" id="L238">                            rs.getLong(&quot;funcionario_id&quot;),</span>
<span class="fc" id="L239">                            rs.getBigDecimal(&quot;valorFinal&quot;),</span>
<span class="fc" id="L240">                            rs.getDate(&quot;dataInicio&quot;).toLocalDate(),</span>
<span class="fc" id="L241">                            rs.getDate(&quot;dataFim&quot;).toLocalDate(),</span>
<span class="fc" id="L242">                            rs.getBoolean(&quot;renovada&quot;)</span>
                    );
                }else {
<span class="nc" id="L245">                    throw new EstruturaBancoException(&quot;Apolice não encontrada: id=&quot; + id);</span>
                }
            }

<span class="nc" id="L249">        }catch (SQLException e){</span>
<span class="nc" id="L250">            throw new EstruturaBancoException(&quot;Erro ao buscar apolices no banco de dados&quot;);</span>
        }
    }

    private void update(Long id){
<span class="fc" id="L255">        String sqlUpdate = &quot;UPDATE apolice SET renovada = TRUE WHERE id = ?&quot;;</span>
<span class="fc" id="L256">        try (Connection con = new ConnectionFactory().getConnection();</span>
<span class="fc" id="L257">        PreparedStatement stmt = con.prepareStatement(sqlUpdate)){</span>

<span class="fc" id="L259">            stmt.setLong(1, id);</span>
<span class="fc" id="L260">            stmt.executeUpdate();</span>
<span class="nc" id="L261">        }catch (SQLException e){</span>
<span class="nc" id="L262">            throw new DadosInvalidosException(&quot;Erro ao atualizar apolices no banco de dados&quot;);</span>
<span class="fc" id="L263">        }</span>
<span class="fc" id="L264">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>